#include "stm32f10x.h"                  // Device header
#include "delay.h"
#include "gpio.h"

uint8_t KeyNum ;	
void Key_Init(void)
{
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);		
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);		//??AFIO???,????????AFIO???
	
	/*GPIO???*/
	GPIO_InitTypeDef GPIO_InitStructure;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_1;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOB, &GPIO_InitStructure);						//?PB0?PB1??????????
	
	/*AFIO??????*/
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource0);//??????0?????GPIOB,???PB0???????
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource1);//??????1?????GPIOB,???PB1???????
	
	/*EXTI???*/
	EXTI_InitTypeDef EXTI_InitStructure;						//???????
	EXTI_InitStructure.EXTI_Line = EXTI_Line0 | EXTI_Line1;		//?????????0???1??
	EXTI_InitStructure.EXTI_LineCmd = ENABLE;					//?????????
	EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;			//????????????
	EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;		//?????????????
	EXTI_Init(&EXTI_InitStructure);								//????????EXTI_Init,??EXTI??
	
	/*NVIC????*/
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);				//??NVIC???2
																//????????:0~3,???????:0~3
																//?????????????????
																//??????,????????main???,while????
																//????????????,????????????????
	
	/*NVIC??*/
	NVIC_InitTypeDef NVIC_InitStructure;						//???????
	NVIC_InitStructure.NVIC_IRQChannel = EXTI0_IRQn;			//????NVIC?EXTI0?
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;				//??NVIC????
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;	//??NVIC?????????1
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;			//??NVIC?????????1
	NVIC_Init(&NVIC_InitStructure);								//????????NVIC_Init,??NVIC??

	NVIC_InitStructure.NVIC_IRQChannel = EXTI1_IRQn;			//????NVIC?EXTI1?
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;				//??NVIC????
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;	//??NVIC?????????1
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;			//??NVIC?????????2
	NVIC_Init(&NVIC_InitStructure);						
}

int16_t KeyNum_Get(void)
{
	int16_t Temp;
	Temp = KeyNum;
	KeyNum = 0;
	return Temp;
}

void EXTI1_IRQHandler(void)
{
	if (EXTI_GetITStatus(EXTI_Line1) == SET)		//?????????1???????
	{
		/*???????????,?????????,?????*/
		if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_1) == 0)
		{
				KeyNum ++;					//????????,??????
			
		}
		EXTI_ClearITPendingBit(EXTI_Line1);			//??????1????????
													//?????????
													//????????????,???????
	}
}
	
//	if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_1) == 0)			
//	{
//		DelayMs(20);										
//		while (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_1) == 0);	
//		DelayMs(20);																					
//	}
//	
//	if (KeyNum % 2 ==0)			
//		{
//				FAN_ON;		
//		}
//else {
//				FAN_OFF;}
//	
//return KeyNum;

